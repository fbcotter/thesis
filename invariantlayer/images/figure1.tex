\begin{figure*}[ht!]
  \centering
  \small
  \resizebox{\textwidth}{!} {
  \begin{tikzpicture}[%
    path image/.style={
      path picture={
        \node at (path picture bounding box.center) {
          \includegraphics[height=2.0cm]{#1}
        };
      }
    }, 
    path pic/.style={
      path picture={
        \node at (path picture bounding box.center) {
          \includegraphics[height=1.2cm]{#1}
        };
      }
    }, 
    path pic2/.style={
      path picture={
        \node at (path picture bounding box.center) {
          \includegraphics[height=0.8cm]{#1}
        };
      }
    }, 
    scale=0.6]

    \tikzcuboid{
    shiftx=-1.5cm,
    shifty=-2.5cm,
    scale=0.5,
    anglex=0, 
    angley=90, 
    anglez=230,
    dimx=3, 
    dimy=3, 
    dimz=6,
    densityx=1, 
    densityy=1, 
    densityz=1,
    shade=false,
    emphedge=true,
    shadeopacity=0,
    emphstyle/.style={rounded corners=0.2pt,line width=0.3mm},
    front/.style={draw=blue!50!white,fill=blue!50!white},%
    right/.style={draw=blue!50!white,fill=blue!50!white},%
    top/.style={draw=blue!50!white,fill=blue!50!white},%
    drawxdims=true,
    dimxval=W,
    drawydims=true,
    dimyval=H,
    drawzdims=true,
    dimzval=C_l,
    }
    \draw (0, .3, 0) node {\large{$x^{(l)}$}};
    \draw [path image=\imgpath/waveys.png, draw=black] (1.5,1.5,0) rectangle (6,0,0);
    \draw (3.75, 1.9, 0) node {\large{$\psi_{j, \theta}$}};
    \draw (1.5,0,0) -- (3,-1.7,0);
    \draw (6,0,0) -- (3.3,-1.7,0);
    \draw [path pic2=\imgpath/lowpass.png, draw=black] (2.5,-2.5,10) rectangle (3.5,-1.5,10);
    \draw (3, -1.1, 10) node {\large{$\phi_{j}$}};
    \draw (3.5,-1.5,10) -- (3.5,-1.7,8);

    % \draw (2.4, -1.5, 0) node {\Large{$\conv$}};
    \draw (2.5, -1.5, 3) node {\Large{$\conv$}};
    \draw [->, fill=gray!30,ultra thick] (4, -1.5, 0) -- (5, -1.5, 0);
    \draw [->, fill=gray!30,ultra thick] (4.5, -1.5, 9) -- (5.85, -1.5, 11);

    \tikzcuboid{
    shiftx=3cm,
    shifty=-1.7cm,
    shiftz=0,
    scale=0.3,
    dimx=1, dimy=1, dimz=4,
    densityx=2, densityy=2, densityz=2,
    drawxdims=false,
    drawydims=false,
    drawzdims=true,
    dimzval=12,
    front/.style={draw=yellow!70!white,fill=yellow!70!white},%
    right/.style={draw=yellow!70!white,fill=yellow!70!white},%
    top/.style={draw=yellow!70!white,fill=yellow!70!white},%
    }
    \tikzcuboid{
    shiftz=8/0.3,
    scale=0.3,
    dimx=1, dimy=1, dimz=1,
    densityx=2, densityy=2, densityz=2,
    drawxdims=false,
    drawydims=false,
    drawzdims=false,
    }


    \tikzcuboid{
    shiftx=6cm,
    shifty=-2.0cm,
    shiftz=0.8cm,
    scale=0.5,
    dimx=2, dimy=2, dimz=4,
    densityx=4, densityy=4, densityz=2,
    drawzdims=true,
    dimzval=C_l,
    front/.style={draw=blue!50!white,fill=blue!50!white},%
    right/.style={draw=blue!50!white,fill=blue!50!white},%
    top/.style={draw=blue!50!white,fill=blue!50!white},%
    }

    \tikzcuboid{
    shiftx=6cm,
    shifty=-2cm,
    shiftz=0cm,
    scale=0.5,
    dimx=2, dimy=2, dimz=24,
    densityx=2, densityy=2, densityz=2,
    drawxdims=true,
    dimxval=\frac{W}{2},
    drawydims=true,
    dimyval=\frac{H}{2},
    drawzdims=true,
    dimzval=12C_l,
    front/.style={draw=blue!50!white,fill=blue!50!white},%
    right/.style={draw=blue!50!white,fill=blue!50!white},%
    top/.style={draw=blue!50!white,fill=blue!50!white},%
    }

    % \draw [->, fill=gray!30,ultra thick] (8.5, -1.5, 0) -- (10.5, -1.5, 0) node[midway, above] (mag) {\large{$\lvert\cdot\rvert$}};
    \draw [->, fill=gray!30,ultra thick] (8.5, -1.5, 0) -- (10.5, -1.5, 0) node[midway, above] (mag) {\Large{ $\lvert \cdot \rvert$} };
    \draw [path pic=\imgpath/mag.png, draw=white] (9.25,0,0) rectangle (11.75,2,0);
    \draw (9.25,0,0) -- (mag.north);
    \draw (11.75,0,0) -- (mag.north);
    \draw[->, fill=gray!30, ultra thick] (8.5, -2, 10) -- (10, -3, 3);

    \tikzcuboid{
    shiftx=11.5cm,
    shifty=-2cm,
    scale=0.5,
    dimx=2, dimy=2, dimz=12,
    densityx=2, densityy=2, densityz=2,
    dimzval=6C_l,
    drawxdims=false,
    drawydims=false,
    front/.style={draw=blue!50!white,fill=blue!50!white},%
    right/.style={draw=blue!50!white,fill=blue!50!white},%
    top/.style={draw=blue!50!white,fill=blue!50!white},%
    }
    \tikzcuboid{
    shiftx=11.5cm,
    shifty=-2cm,
    shiftz=8,
    scale=0.5,
    drawxdims=true,
    drawydims=true,
    dimx=2, dimy=2, dimz=4,
    densityx=2, densityy=2, densityz=2,
    dimzval=C_l,
    front/.style={draw=blue!50!white,fill=blue!50!white},%
    right/.style={draw=blue!50!white,fill=blue!50!white},%
    top/.style={draw=blue!50!white,fill=blue!50!white},%
    }
    \draw (13.2, 0.8, 0) node {\large{$z^{(l+1)}$}};
    \draw (20.5, 0.3, 0) node {\large{$x^{(l+1)}$}};
    \draw (14, -1.5, 0) node {\Large{$\conv$}};

    \tikzcuboid{
    shiftx=15.2cm,
    shifty=-1.0cm,
    shiftz=0,
    scale=0.5,
    dimx=0.4, dimy=0.4, dimz=14,
    densityx=5, densityy=5, densityz=2,
    drawxdims=false,
    drawydims=false,
    drawzdims=false,
    front/.style={draw=red!50!white,fill=red!50!white},%
    right/.style={draw=red!50!white,fill=red!50!white},%
    top/.style={draw=red!50!white,fill=red!50!white},%
    }
    \tikzcuboid{
    shifty=-1.65cm,
    }
    \tikzcuboid{
    shifty=-3.0cm,
    scale=0.5,
    drawxdims=true,
    dimxval=1,
    drawydims=true,
    dimyval=1,
    drawzdims=true,
    dimzval=7C_l,
    }
    \draw (15.5, -1.8, 0) node {$\vdots$};
    \draw [<->] (15.7, -0.8, -3) -- (15.7, -3, -3) node[near start, right] {$C_{l+1}$};
    \draw [->, fill=gray!30,ultra thick] (17.5, -1.5, 0) -- (18.5, -1.5, 0)
      node[midway, above] {$\sigma$};

    \tikzcuboid{
    shiftx=19.5cm,
    shifty=-2.0cm,
    scale=0.5,
    dimx=2, dimy=2, dimz=6,
    densityx=4, densityy=4, densityz=2,
    drawzdims=true,
    dimzval=C_{l+1},
    drawxdims=true,
    dimxval=\frac{W}{2},
    drawydims=true,
    dimyval=\frac{H}{2},
    front/.style={draw=blue!50!white,fill=blue!50!white},%
    right/.style={draw=blue!50!white,fill=blue!50!white},%
    top/.style={draw=blue!50!white,fill=blue!50!white},%
    }

  \end{tikzpicture}

  }
  \caption{Block Diagram of Proposed Invariant Layer for $J=1$. Activations are shaded
  blue, fixed parameters yellow and learned parameters red. Input
  $x^{(l)}\in \mathbb{R}^{C_l\x H\x W}$ is filtered by real and imaginary oriented
  wavelets and a lowpass filter and is downsampled. The channel dimension
  increases from $C_l$ to $(2K+1)C_l$, where the number of orientations is $K=6$.
  The real and imaginary parts are combined by taking their magnitude (an
  example of what this looks like in 1D is shown above the magnitude operator) -
  the components oscillating in quadrature are combined to give $z^{(l+1)}$. The
  resulting activations are concatenated with the lowpass filtered activations,
  mixed across the channel dimension, and then passed through a nonlinearity
  $\sigma$ to give $x^{(l+1)}$.  If the desired output spatial size is $H\x W$,
  $x^{(l+1)}$ can be bilinearly upsampled paying only a few multiplies per
  pixel.}
  \label{fig:block_diagram}
  \vspace{-10pt}
\end{figure*}

